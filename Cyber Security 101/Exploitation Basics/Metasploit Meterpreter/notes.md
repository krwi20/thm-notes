Introduction to Meterpreter
- Meterpreter is a Metasploit payload that supports the penetration testing process
- Meterpreter will run on the target system and act as an agent within a command and control architecture
- you will interact with the operating system and files and use Meterpreter's specialised commands

- Meterpreter has many versions which will provide different functionalities based on the target system

How does Meterpreter work?
- Meterpreter runs on the target system but is not installed on it
- it runs in memory and does not write itself to the disk on the target
- this feature aims to avoid being detected during antivirus scans
- by default most antivirus software will scan new files on the disk (e.g. when you download a file from the internet)
- Meterpreter runs in memory (RAM - Random Access Memory)
- to avoid having a file that haws to be written to the disk on the target system (e.g. meterpreter.exe)
- this way Meterpreter will be seen as a process and not have a file on the target system

- Meterpreter also aims to avoid being detected by network-based IPS (Intrusion Prevention System)
- and IDS (Intrusion Detection System) solutions by using encrypted communication with the server where Metasploit runs (typically your attacking machine)
- if the target org does not decrypt and inspect encrypted traffic (e.g. HTTPS) coming to and going out of the local network, IPS and IDS solutions will not be able to detect its activities

- while Meterpreter is recognised by major antivirus software, this feature provides some degree of stealth

- the example below shows a target windows machine using the MS17-010 vulnerability
- you will see Meterpreter is running with a process ID (PID) of 1304; this PID will be different in your case
- we have used the getpid command which returns the process ID with which Meterpreter is using
- the process ID (or process identifier) is used by operating systems to identify running processes
- all processes running in Linux or Windows will have a unique ID number...
- this number is used to interact with the process when the need arises (e.g. if it needs to be stopped)

![getpid](images/getpid.png "getpid")

- if we list processes running on the target system using the ps command we see PID 1304 is spoolsv.exe and not Meterpreter.exe as one might expect

![the_ps_command](images/the_ps_command.png "the_ps_command")

- even if we were to go a step further and look at DLLs (Dynamic-Link Libraries) used by the Meterpreter process (PID 1304 in this case) we still would not find anything jumping at us (e.g. no meterpreter.dll)

![the_meterpreter_process](images/the_meterpreter_process.png "the_meterpreter_process")

- techniques and tools that can be used to detect Meterpreter are beyond the scope of this room
- this section aimed to show you how stealthy Meterpreter is running; remember, most antivirus software will detect it

- it is also worth nothing that Meterpreter will establish an encrypted (TLS) communication channel with the attackers system

Meterpreter Flavors
- as discussed in the prev Metasploit rooms, linked below, Metasploit payloads can be initially divided into 2 categories:
- inline (also called single)
- staged
- Introduction to Metasploit: https://www.tryhackme.com/jr/metasploitintro
- Scanning and Exploitation with Metasploit: https://www.tryhackme.com/jr/metasploitexploitation

- as you will remembner staged payloads are sent to the target in 2 steps
- an initial part is installed (the stager) and requests the rest of the payload
- this allows for a smaller initial payload size
- the inline payloads are sent in a single step
- Meterpreter payloads are also divided in to stagged and inline versions
- however Meterpreter has a wide range of different versions you can choose from based on your target system

- the easiest way to have an idea about available Meterpreter versions could be to list them using msfvenom as seen below

- we have used the msfvenom --list payloads command and grepped "meterpreter" payloads (adding | grep meterpreter to the cmd line) so the output only shows these
- you can try this command on the AttackBox

![listing_meterpreter_payloads](images/listing_meterpreter_payloads.png "listing_meterpreter_payloads")

- the list will show Meterpreter versions available for the following platforms:
- Android
- Apple iOS
- Java
- Linux
- OSX
- PHP
- Python
- Windows

- your decision on which version of Meterpreter to use will be mostly based on 3 factors:

- the target os (is the target os Linux or Windows? is it a Mac device? is it an Android phone? etc)

- components available on the target system (is Python installed? is this a PHP website? etc)

- network connection types you can have with the target system (do they allow raw TCP connections? can you only have an HTTPS reverse connection? are IPv6 addresses not as closely monitored as IPv4 addresses? etc)

- if you are not using Meterpreter as a standalone payload generated by msfvenom, your choice may also be limited by the exploit
- you will notice some exploits will have a default Meterpreter payload, as you can see in the example below with the ms17_010_eternalblue exploit

![default_payload_for_ms17-010](images/default_payload_for_ms17-010.png "default_payload_for_ms17-010")

- you can also list other available payloads using the show payloads command with any module

![available_payloads](images/available_payloads.png "available_payloads")

Meterpreter Commands
- typing help on any Meterpreter session (shown by meterpreter> at the prompt) will list all available commands

![the_meterpreter_help_menu](images/the_meterpreter_help_menu.png "the_meterpreter_help_menu")

- every version of Meterpreter will have different command options so running the help command is always a good idea
- comamnds are built-in tools available on Meterpreter
- they will run on the target system without loading any additional scripts or executable files

- Meterpreter will provide you with 3 primary categories of tools;
- built-in commands
- Meterpreter tools
- Meterpreter scripting

- if you run the help command you will see Meterpreter commands are listed under different categories
- Core commands
- File system commands
- Networking commands
- System commands
- User interface commands
- Webcam commands
- Audio output commands
- Elevate commands
- Password database commands
- Timestomp commands

- please note that the lsit above was taken from the output of the help command on the Windows version of Meterpreter (windows/x64/meterpreter/reverse_tcp)
- these will be different for other Meterpereter versions

Meterpreter Commands
- core commands will be helpful to navigate and interact with the target system
- below are some of the most commonly used
- remember to check all available commands running the help command once a Meterpreter session has started

Core Commands
- background: backgrounds the current session
- exit: terminate the Meterpreter session
- guid: get the session GUID (GLobally Unique Identifier)
- help: displays the help menu
- info: displays info about a post module
- irb: opens an interactive ruby shell on the current session
- load: loads one or more Meterpreter extensions
- migrate: allows you to migrate Meterpreter to another process
- run: executes a Meterpreter script or Post module
- sessions: quickly switch to another session

File System Commands
- cd: will change directory
- ls: will list files in the current directory (dir will also work)
- pwd: prints the current working directory
- edit: will allow you to edit a file
- cat: will show the contents of a file to the screen
- rm: will delete the specified file
- search: will search for files
- upload: will upload a file or directory
- download: will download a file or directory

Networking Commands
- arp: displays the host ARP (Address Resolution Protocol) cache
- ifconfig: displays network interfaces available on the target system
- netstat: displays the network connections
- portfwd: forwards a local port to a remote service
- route: allows you to view and modify the routing table

System Commands
- clearev: clears the event logs
- execute: executes a command
- getpid: shows the current process identifier
- getuid: shows the user that Meterpreter is running as
- kill: terminates a process
- pkill: terminates processes by name
- ps: list running processes
- reboot: reboots the remote computer
- shell: drops into a system command shell
- shutdown: shuts down the remote computer
- sysinfo: gets information about the remote system such as OS

Other Commands (these will be listed under different menu categories in the help menu)
- idletime: returns the number of seconds the remote user has been idle
- keyscan_dump: dumps the keystroke buffer
- keyscan_start: starts capturing keystrokes
- keyscan_stop: stops capturing keystrokes
- screenshare: allows you to wach the remote users desktop in real time
- screenshot: grabs a screenshot of the interactive desktop
- record_mic: records audio from the default microphone for X seconds
- webcam_chat: starts a video chat
- webcam_list: lists webcams
- webcam_snap: takes a snapshot from the specified webcam
- webcam_stream: plays a video stream from the specified webcam
- getsystem: attempts to elevate your privilege to that of local system
- hashdump: dumps the contents of the SAM database

- although all these commands may seem available under the help menu, they may not all work
- for example the target system might not have a webcam or it can be running on a virtual machine without a proper desktop environment 

Post-Exploitation with Meterpreter
- Meterpreter provides you with many useful commands that facilitate the post-exploitation phase
- below are a few examples you will often use

Help
- this command will give you a list of all available commands in Meterpreter
- as we have seen earlier Meterpreter has many versions, and each version may have different options available
- typing help once you have a Meterpreter session will help you quickly browse through available commands

![the_meterpreter_help_menu_2](images/the_meterpreter_help_menu_2.png "the_meterpreter_help_menu_2")

Meterpreter Commands
- the getuid command will display the user with which Meterpreter is currently running
- this will give you an idea of your possible privilege level on the target system (e.g. are you an admin level user like NT AUTHORITY\SYSTEM or a regular user?)

![the_getuid_command](images/the_getuid_command.png "the_getuid_command")

- the ps command will list running processes
- the PID column will also give you the PID information you will need to migrate Meterpreter to another process

![the_ps_command_2](images/the_ps_command_2.png "the_ps_command_2")

Migrate
- migrating to another process will help Meterpreter interact with it
- for example if you see a word processor running on the target (e.g. word.exe, notepad.exe etc) you can migrate to it and start capturing keystrokes sent by the user to this process
- some Meterpreter versions will offer you the keyscan_start, keyscan_stop and keyscan_dump command options to make Meterpreter act like a keylogger
- migrating to another process may also help you to have a more stable Meterpreter session

- to migrate any process you need to type the migrate command followed by the PID of the desired target process
- the example below shows Meterpreter migrating to process ID 716

![the_migrate_command](images/the_migrate_command.png "the_migrate_command")

- be careful; you may lose your user privileges if you migrate from a higher priviliged (e.g. SYSTEM) user to a process started by a lower priviliged user (e.g. webserver)
- you may not be able to gain them back

Hashdump
- the hashdump command will list the content of the SAM db
- the SAM (Security Account Manager) db stores user's passwords on the Windows systems
- these passwords are stored in the NTLM (New Technology LAN Manager) format

![the_hashdump_command](images/the_hashdump_command.png "the_hashdump_command")

- while its not mathematically possible to "crack" these hashes you may still discover the cleartext password using online NTLM databases or a rainbow table attack
- these hashes can also be used in Pass-the-Hash attacks to authenticate to other systems that these users can access the same network

Search
- the search command is useful to locate files with potentially juicy information
- in a CTF context, this can be used to quickly find a flag or proof file, while in actual pentesting engagements you may need to search for user-generated files or config files that may contain password or account info

![the_search_command](images/the_search_command.png "the_search_command")

Shell
- the shell command will launch a regular command-line shell on the target system
- pressing CTRL+Z will help you go back to the Meterpreter shell

![the_shell_command](images/the_shell_command.png "the_shell_command")

Post-Exploitation Challenge
- Meterpreter provides several important post-exploitation tools

- commands mentioned previously such as getsystem and hashdump will provide important leverage for privilege escalation and lateral movement
- Meterpreter is also a good base you can use to run post-exploitation modules available on the Metasploit Framework
- finally you can also use the load command to leverage additional tools such as Kiwi or even the whole Python language

![loading_python](images/loading_python.png "loading_python")

- the post-exploitation phase will have several goals
- Meterpreter has functions that can assist all of them

- Gathering further information about the target system
- Looking for interesting files, user credentials, additional network interfaces, and generally interesting info on the target system
- Privilege escalation
- Lateral movement

- once any additional tool is loaded using the load command you will see new options on the help menue
- the example below shows commands added for the Kiwi module (using the load kiwi command)

![loading_kiwi](images/loading_kiwi.png "loading_kiwi")

- these will change according to the loaded menu so running the help command after loading a module is always a good idea

![the_updated_help_menu](images/the_updated_help_menu.png "the_updated_help_menu")

- the questions below will help you have a better understanding of how Meterpreter can be used in post-exploitation
- you can use the credentials given to simulate an initial compromise over SMB (Server Message Block) (using exploit/windows/smb/psexec)

What is the computer name?
- ACME-TEST

working out: 
- first we have to get the meterpreter session to the target machine
- we are told to use the credentials and simulate an initial compromise over SMB using exploit/windows/smb/psexec
- so we open msfconsole
- set exploit/windows/smb/psexec
- set the RHOSTS
- set the SMBUser and SMBPass

![answer_1_1](images/answer_1_1.png "answer_1_1")

- run exploit command

![answer_1_2](images/answer_1_2.png "answer_1_2")

- we now have a Meterpreter session
- running help once initially opening a session is a good idea
- we can run sysinfo to get more information about the remote system
- results show us the Computer name : ACME-TEST

![answer_1_3](images/answer_1_3.png "answer_1_3")

What is the target domain?
- in the above scrnshot we can also see that the Domain on the target is FLASH
- FLASH

What is the name of the share likely created by the user?
- speedster

working out:
- if we background the session
- we can search for share to find some potential modules
- we can see there is a post/windows/gather/enum_shares
- "Windows Gather SMB Share Enumeration via Registry"
- we can go back into the session with sessions -i 1
- we can either use that module and set the session param and run
- or we can go back into the session with sessions -i 1 and try to run it inline with run post/windows/gather/enum_shares
- the name of the share most likely created by the user is speedster

![answer_2](images/answer_2.png "answer_2")

What is the NTLM hash of the jchambers user?
- 69596c7aa1e8daee17f8e78870e25a5c

working out:
- we can run hashdump command in the Meterpreter command line to get this info

![answer_3](images/answer_3.png "answer_3")

What is the cleartext password of the jchambers user?
- Trustno1

working out:
- we can use an online tool, i used ntlm to password, crackstation is another good site
- entered the hash and got the plaintext password Trustno1

Where is the "secrets.txt"  file located? (Full path of the file)
- c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt

working out:
- we can use the search command to help us find this
- search -f secrets.txt

![answer_4](images/answer_4.png "answer_4")

What is the Twitter password revealed in the "secrets.txt" file?
- KDSvbsw3849!

working out: 
- we can cd into that directory and then cat the secrets.txt to see the content

![answer_5](images/answer_5.png "answer_5")

Where is the "realsecret.txt" file located? (Full path of the file)
- c:\inetpub\wwwroot\realsecret.txt

working out:
- same as before using the search command
- search -f realsecret.txt

![answer_6](images/answer_6.png "answer_6")

What is the real secret?
- The Flash is the fastest man alive

working out:
- again go to the directory and cat the file to get the content

![answer_7](images/answer_7.png "answer_7")